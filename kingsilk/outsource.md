




 

 
## 各个系统与角色

|               |平台商|商家|代理商|经销商|消费者|
|---------------|------|-----|-----|-----|-----|
|微信网关        |管理   |     |     |     |     |
|聚合支付平台     |管理   |     |使用  |使用  |使用  |
|统一登录后台     |管理   |     |     |     |     |
|统一登录前端     |      |使用 |使用  |使用 |使用  |
|平台管理后台     |管理   |     |     |     |     |
|短网址系统       |管理   |使用  |使用  |使用  |     |
|短信网关?        |管理   |     |     |     |     |
|多媒体管理系统?   |管理   |使用  |使用  |使用 |     |
|品牌商管理后台   |      |管理  |      |    |     |
|经销商进销存系统  |      |     |使用  |使用 |     |
|商城管理后台     |      |使用  |      |    |     |
|商城            |      |     |      |    |使用  |
|定制业务模块     |      |?    |?     |?   |?     |
|防伪溯源验证系统  |     |      |     |     |使用     |
|废弃业务模块     |      |     |      |    |      |
|平台官网        |管理   |查看  |查看  |查看  |查看  |


## 角色说明

* 平台商

    这里特指 杭州钱皇网络技术有限公司 的员工，主要负责规划平台功能、实现并测试后上线、线上环境运维管理。

    * 产品经理：分析业务流程、
    * 架构师：数据库设计、API设计、程序架构设计、devops 实践。
    * 测试人员：测试
    * UI设计人员：
    * 自有开发人员：数据设计、API设计、编写测试用例（程序）——对外包代码进行测试、
       服务器运维

* 商家
    
    指 钱皇蚕丝被、江南古韵蚕丝被、洲泉蚕丝被、三月三等品牌运营实体。
    
    * 推广部
    * 运营部
    * 客服部：在线客服，提供业务咨询、订单跟踪、产品介绍
    * 仓储部：商品入库、出库、订单发货、接收退货、代理商之间库存调拨
    * 财务部：
    
* 代理商
 
    只各个品牌商下的 区域代理商，可以有层级关系。即便一个代理商独立实体，在各个品牌商中也是不同的对象。
    
    代理商有更高的要求，和更低商品进价。

* 经销商

    与经销商类似，但没有保护区域，准入门槛低，向代理商或商家直接进货。
    
* 消费者

    指个人普通消费者

## 系统说明

* 平台官网
    
    * 平台自宣传的介绍
    
* 短网址系统

    * 提供缩短网址的API
    * 提供生成二维码图片的API。
    * 对于认证过的系统，提供短网址模板管理相关界面和API

* 微信网关

    * 监听多个微信公众号、代运营微信公众号、微信企业号、代运营微信企业号时，微信的消息推送，并转发到MQ中。
    * 定时刷新微信的 AccessToken，Refresh Token. JS token, 用户级别的 用户授权 AccessToken。
    * 同步微信公众号中关注信息用户列表，未关注但已授权的用户的信息列表。
    * 提供计算 JSTicket 相关签名的 API
    
* 短信网关

    * 包装第三方发送短信的API，以便今后能在发短信提供商之间切换。
    * 短信模板维护。维护的同时，内部要需要到短信提供商（云片网、阿里大于等）自动、手动更新相应的设置。
    * 短信记录日志

* 多媒体管理系统

    * 利用第三方CDN（七牛云、阿里云等）存储图片、音频、视频等资源。
    * 自身可以不存储资源文件内容，但存储资源元信息：比如文件名，图片类型，用户自定义的标签等，CDN中的路径信息等。
    * 以多种视图（比如文件目录）的格式管理文件资源，提供查找，复制资源CDN引用地址等功能。
    * 可选：提供哪些文件在什么地方比使用，最近访问日志等信息。
    * 可选：提供上传、搜索视图组件，以方便在其他子系统内搜索、引用、上传等嵌入式操作。

* 聚合支付平台
    
    已有许多第三方服务，比如 Ping++ 等。需要针对 Web 端、移动端、微信端等提供针对 支付宝、微信、银行卡、信用卡等多种支付方式。
    
    FIXME: 是否选用第三方服务，而非自己开发。第三方服务是否能满足需求、易于对接？


* 统一登录后台

    只有 平台商 员工才能登录，属于高级敏感功能：
    
    * 用户信息管理。
    * 各个子系统授权管理——即该用户能否登录某些子系统。
    * 用户信息维护：尽量只看不动。锁定、禁用、直接修改、无验证重置密码。
    * 用户组织维护：尽量只看不动。
    * 用户组织下员工权限维护：尽量只看不动。
    * 权限元信息："统一登录前端" 在配置员工权限时，展示哪些权限名称。

* 统一登录前端

    * 移动端界面展示
    * 用户注册画面
    * 基于 OAuth 提供单点登录
    * 绑定/解绑第三方账户
    * 绑定/解绑手机号
    * 绑定/解绑电子邮箱
    * 修改密码
    * 密码找回
    * 维护个人信息
    * 维护联系方式
    * 维护收货地址
    * 可选——提供实名认证界面
    * 组织管理：平台商、品牌商、代理商、经销商均需要在这里有相应的组织信息。该信息在所有子系统内共享。
        * 员工管理
        * 权限管理
        * 微信公众号、企业号待运营模式：子系统：授权、解除授权   
    * 提供用户查询API，以及相应的UI组件，以方便在其他子系统中调用

* 平台管理后台

    * 管理 品牌商 的资质信息、登录账号信息。
    * 管理 平台商 的平台使用费、保证金、 或基于订单流水的佣金等
    * 各种统计、监控

* 品牌商管理后台

    * 经销商管理
    * 基础商品管理：
        * 定义商品编码
        * 定义商品图文模板 （为经销商进货系统，微商城提供商品图文详情模板）
        * 商品批次管理
        * 商品二维码管理
    * 经销商-进货单管理
    * 经销商-退货单管理
    * 库存管理

* 经销商进销存系统

    * 商品浏览
    * 购物车
    * 下单
    * 订单管理
    * 退货管理
    * 库存管理
    * 调拨管理
    

* 商城管理后台

   FIXME: 经销商、代理商不允许以该

    * 商品管理
    * 活动管理（单品折扣，单品满减满送、订单类折扣、订单类满减满送、拼团、砍价、抽奖等）
    * 积分管理
    * 优惠券管理
    * 余额/钱包管理
    * 佣金管理
    * 订单管理
    * 话题管理
    * 评论管理
    * 积分商品管理 —— 需要制定更通用的积分规则以及代码实现

* 商城

    * 会员管理
    * 活动、商品展示
    * 购物车
    * 下单
    * 订单管理
    * 退货管理
    * 余额/钱包管理
    * 佣金管理
    * 优惠券管理

* 定制业务模块

    * 杀菌消毒柜
    * 菜谱 （三月三有用到）
    * 服务 （钱皇、江南古韵、洲泉有用到）
    * 洗护管理
    * 溯源管理
    * 礼品卡

* 防伪溯源验证系统

    * 消费者登录查询产品真实性
    * 参与抽奖活动
        

* 废弃业务模块

    * 租赁管理
    * 资产管理
    * 配送管理
    * 员工内购
    


## 关于开发外包

### 优点

1. 软件质量会大幅提高
1. 开发流程会规范化
1. 文档化程度会提高
1. 加强软件的测试
1. 加强运行的监控
1. 更多精力放在产品需求的分析，确定解决方案上。

### 缺点

1. 开发成本肯定是大幅提高
1. 开发进度不见得会加快 —— 除非多个子系统的开发能多个外包团队并行。
   也许还会遇到相互扯皮——造成进度延迟。
1. 问题响应不会太迅速 —— 流程长了
1. 会对外包公司的团队先进行技术培训，更换外包公司时也需要。



### 对杭州钱皇IT部门的影响

1. 仍需要维持一定规模的开发人员的数量，以自己解决问题，对应bug。
1. 自己的人员主要以数据库设计、流程设计、设计文档化、API设计、服务器运维、监控、编写测试用例(现状是编写业务实现)
1. 从分析、设计、编码实现、服务器运维， 转变为 分析、设计、测试验收、服务器运维。
1. 需严格控制版本，交付验收流程。
1. 需多用持续集成、自动化部署，相关工具。
1. 需要有人擅长商务谈判（工期、工作内容、价格、外包成果争议谈判）。
    萝卜，有作为乙方的经验，应该能一定程度的承担该角色。
    般若，请无视。

1. 需要投入相当的精力再测试验收上，比如编码规约，程序代码质量检测，代码review，测试用例准备，手动测试，压力测试等。
   这些，代码相关的有部分进行，但也很少。

### 担忧



### 职责划分

|                              |自己做    |外包|
|------------------------------|---------|----|
|需求分析                       |Yes      |     |
|产品原型图                      |Yes      |    |
|产品UI效果图                    |Yes      |    |
|技术调研、确认最佳实践、软件架构   |Yes      |    |
|数据库设计的相关文档和代码        |Yes      |    |
|测试验收环境                    |Yes      |     |
|线上环境的搭建与操作             |Yes      |     |
|Demo工程                       |Yes      |     |
|持续集成环境搭建、操作           |主        |辅   |
|手动验收测试                    |Yes      |     |
|验收测试代码                    |Yes      |     |
|单元测试代码                    |         |Yes  |
|RESTFul API 设计的相关文档和代码 |Yes      |     |
|RESTFul API 的实现             |         |Yes  |
|前端工程的URL设计               |Yes      |     |
|前端工程开发                    |         | Yes |


## 软件架构设计

   


### 第三方服务

|提供商  |服务                    |  后付费？|初期规格             |数量   |费用/年（预估）|
|-------|------------------------|---------|--------------------|------|-----------|
|gitlab |私有 git 仓库服务         |         |                    |      |0          |
|阿里云  |私有 docker 镜像仓库服务  |         |                     |     |0          |
|阿里云  |npm 镜像加速服务          |        |                     |      |0          |
|阿里云  |maven 镜像加速服务        |        |                      |       |0          |
|网易    |七鱼                   |        |                      |       |1888/坐席   |
|阿里云  |VPC 私有网络             |        |                      |       |           |
|阿里云  |NAT 网关服务             |        |华东1区，Small         |1       |=12*365=4380 |
|阿里云  |Docker 容器服务          |        |                      |       |？         |
|阿里云  |NAS 文件存储服务          |        |                     |       |？        |
|阿里云  |OSS 对象存储服务          |        |                     |       |？          |
|阿里云  |证书服务                 |        |免费DV型证书           |       |0          |
|阿里云  |CDN 加速服务             |        |                      |       |？          |
|阿里云  |阿里大于 短信服务         |        |                      |       |？          |


 ### 自建 docker 服务
 
 |环境 | docker 服务            |数量       |说明|
 |-----|-----------------------|----------|-----|
 |prod |Sonar Nexus 2          |1          |启用私有 Maven，NPM 仓库功能，先不用其私有 docker 容器仓库的功能|
 |prod |SonarQube              |1          |代码质量检测工具|
 |prod |PostGresql             |1          |SonarQube 使用 |
 |prod |Gitlab Runner 服务      |`>=1`     |      |
 |prod |RabbitMQ               |1          |消息队列服务,dev,test,prod 服务共享 |
 |prod |ElasticSearch          |1          |搜索服务，各个环境隔离 |
 


### 开发使用的框架

* java。 而当前为了加快开发进度，使用的是 groovy，但关于代码静态分析工具相比 java 则缺少不少。
* spring-boot
* spring-security
* spring-security-oauth2
* spring-data-mongodb
* spring-data-elasticsearch
* spring-integration
* spring-session : 只有 "统一登录前端" 工程使用 
* spring-cloud
* angularJS 1 (FIXME: angular2)
* webpack


### 开发环境准备

* 基于 VirtualBox 虚拟机的 Lubuntu 标准开发环境
    * JDK 8
    * IDEA Intellij
    * NVM
    * docker ??



### 开发顶层设计内容

* 数据库设计的 jar 包
* ElasticSearch 设计的 jar 包
* 配置文件的格式的 java 类
* RabbitMq 的 route key
* 前端单网页开发的 URL 路径
* 后端 API 开发的 URL 路径
* gitlab-ci.yml
* .editorconfig
* .gitignore
* 服务的 docker 镜像仓库
    

















